#!/bin/bash

# ==========================================================
#  TOMATO LUXE THEME ENGINE - CLOUD BACKUP
# ==========================================================

# 1. Palette Definition (True Color)
C_TOMATO="\033[38;2;217;69;57m"   # Primary Red
C_BURGUNDY="\033[38;2;143;38;38m" # Border Red
C_SAGE="\033[38;2;148;180;159m"   # Success Green
C_GOLD="\033[38;2;230;203;165m"   # Warning/Highlight
C_CREAM="\033[38;2;253;251;247m"  # Text
C_RESET="\033[0m"

# 2. Icons
ICON_CLOUD="â˜ï¸"
ICON_DISK="ğŸ’¾"
ICON_LOCK="ğŸ”’"
ICON_CHECK="âœ”"
ICON_WARN="âš ï¸"
ICON_SEND="âœˆï¸"
ICON_GEAR="âš™"

# ==========================================================
#  UI FUNCTIONS
# ==========================================================

draw_header() {
    clear
    echo -e "${C_BURGUNDY}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${C_RESET}"
    echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_SAGE}      ${ICON_CLOUD}  ${C_TOMATO}TOMATO MANAGER BACKUP${C_RESET} ${C_GOLD}(G-DRIVE SYNC)${C_RESET}        ${C_BURGUNDY}â•‘${C_RESET}"
    echo -e "${C_BURGUNDY}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${C_RESET}"
    echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_CREAM}System Backup -> Upload -> Telegram Link${C_RESET}             ${C_BURGUNDY}â•‘${C_RESET}"
    echo -e "${C_BURGUNDY}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${C_RESET}"
    echo -e ""
}

print_step() {
    echo -e "  ${C_GOLD}${ICON_GEAR} $1...${C_RESET}"
}

print_success() {
    echo -e "  ${C_SAGE}${ICON_CHECK} $1${C_RESET}"
    sleep 0.5
}

print_error() {
    echo -e "  ${C_TOMATO}âŒ Error: $1${C_RESET}"
    exit 1
}

# ==========================================================
#  MAIN LOGIC
# ==========================================================

draw_header

# --- 1. PRE-CHECK ---
print_step "Checking dependencies"
for cmd in rclone zip curl; do
    if ! command -v $cmd &> /dev/null; then
        print_error "$cmd is not installed. Please install it first."
    fi
done
print_success "Dependencies met"

# --- 2. GET CONFIG ---
print_step "Loading configurations"
CHATID=$(grep -E "^#bot# " "/etc/bot/.bot.db" | cut -d ' ' -f 3)
KEY=$(grep -E "^#bot# " "/etc/bot/.bot.db" | cut -d ' ' -f 2)
DOMAIN=$(cat /etc/xray/domain 2>/dev/null || echo "IP-Only")
IP=$(curl -4 -sS icanhazip.com)
DATE=$(date +"%Y-%m-%d")
BACKUP_NAME="backup-$IP-$DATE.zip"
TEMP_DIR="/tmp/backup_$DATE"

if [ -z "$CHATID" ] || [ -z "$KEY" ]; then
    print_error "Telegram Bot config not found in /etc/bot/.bot.db"
fi
print_success "Config loaded"

# --- 3. CREATE BACKUP ---
print_step "Gathering system files"
mkdir -p "$TEMP_DIR"

# Copy files (Suppress output)
cp -a /etc/passwd /etc/group /etc/shadow /etc/gshadow /etc/crontab "$TEMP_DIR/" 2>/dev/null
[ -d "/etc/xray" ] && cp -a /etc/xray "$TEMP_DIR/" 2>/dev/null
[ -d "/var/lib/kyt" ] && cp -a /var/lib/kyt "$TEMP_DIR/" 2>/dev/null
[ -d "/var/www/html" ] && cp -a /var/www/html "$TEMP_DIR/" 2>/dev/null
[ -d "/etc/zivpn" ] && cp -a /etc/zivpn "$TEMP_DIR/" 2>/dev/null

print_step "Compressing archive"
if zip -rq "/root/$BACKUP_NAME" "$TEMP_DIR"; then
    FILE_SIZE=$(du -h "/root/$BACKUP_NAME" | cut -f1)
    rm -rf "$TEMP_DIR"
    print_success "Backup created: $BACKUP_NAME ($FILE_SIZE)"
else
    print_error "Compression failed"
fi

# --- 4. UPLOAD TO DRIVE (RCLONE) ---
# Note: Pastikan remote rclone bernama "dr" atau sesuaikan di script ini
print_step "Uploading to Google Drive (Remote: dr)"

if rclone copy "/root/$BACKUP_NAME" "dr:backup/" >/dev/null 2>&1; then
    print_success "Upload successful"
else
    print_error "Rclone upload failed. Check your rclone config."
fi

print_step "Generating Download Link"
DRIVE_LINK=$(rclone link "dr:backup/$BACKUP_NAME")

if [ -z "$DRIVE_LINK" ]; then
    print_error "Failed to generate link. File might be private or path is wrong."
fi
print_success "Link generated"

# --- 5. SEND NOTIFICATION ---
print_step "Sending Telegram Notification"

TEXT="<b>â˜‰â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â˜‰</b>
<b> ${ICON_CLOUD} TOMATO CLOUD BACKUP</b>
<b>â˜‰â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â˜‰</b>
<b>ğŸ“… Date    :</b> <code>$DATE</code>
<b>ğŸ–¥ï¸ IP VPS  :</b> <code>$IP</code>
<b>ğŸŒ Domain  :</b> <code>$DOMAIN</code>
<b>ğŸ“¦ Size    :</b> <code>$FILE_SIZE</code>
<b>â˜‰â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â˜‰</b>
<b>ğŸ“¥ GOOGLE DRIVE LINK:</b>
<code>$DRIVE_LINK</code>
<b>â˜‰â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â˜‰</b>
<b>${ICON_LOCK} Keep this link safe!</b>"

curl -s -X POST "https://api.telegram.org/bot$KEY/sendMessage" \
    -d chat_id="$CHATID" \
    -d text="$TEXT" \
    -d parse_mode="HTML" \
    -d disable_web_page_preview="true" > /dev/null

if [ $? -eq 0 ]; then
    print_success "Notification sent"
else
    echo -e "  ${C_GOLD}${ICON_WARN} Warning: Telegram notification failed${C_RESET}"
fi

# --- 6. CLEANUP ---
# Optional: Remove local file after upload to save space
# rm -f "/root/$BACKUP_NAME"

# --- FINAL OUTPUT ---
echo -e ""
echo -e "${C_BURGUNDY}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${C_RESET}"
echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_SAGE}${ICON_CHECK}       ${C_TOMATO}BACKUP PROCESS COMPLETED${C_RESET}        ${C_SAGE}${ICON_CLOUD}${C_RESET}          ${C_BURGUNDY}â•‘${C_RESET}"
echo -e "${C_BURGUNDY}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${C_RESET}"
echo -e ""
echo -e "  ${C_GOLD}Link:${C_RESET} ${C_CREAM}$DRIVE_LINK${C_RESET}"
echo -e ""