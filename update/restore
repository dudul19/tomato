#!/bin/bash
# ==========================================================
#  TOMATO LUXE THEME ENGINE - RESTORE TOOL
# ==========================================================

# 1. Palette Definition (True Color)
C_TOMATO="\033[38;2;217;69;57m"   # Primary Red
C_BURGUNDY="\033[38;2;143;38;38m" # Border Red
C_SAGE="\033[38;2;148;180;159m"   # Success Green
C_GOLD="\033[38;2;230;203;165m"   # Warning/Highlight
C_CREAM="\033[38;2;253;251;247m"  # Text
C_RESET="\033[0m"

# 2. Icons
ICON_RESTORE="♻️"
ICON_DISK="💾"
ICON_CLOUD="☁️"
ICON_WARN="⚠️"
ICON_CHECK="✔"
ICON_DL="📥"
ICON_GEAR="⚙"

# ==========================================================
#  UI FUNCTIONS
# ==========================================================

draw_header() {
    clear
    echo -e "${C_BURGUNDY}╔══════════════════════════════════════════════════════╗${C_RESET}"
    echo -e "${C_BURGUNDY}║${C_RESET} ${C_SAGE}        ${ICON_RESTORE}    ${C_TOMATO}TOMATO MANAGER${C_RESET} ${C_GOLD}(DATA RECOVERY)${C_RESET}          ${C_BURGUNDY}║${C_RESET}"
    echo -e "${C_BURGUNDY}╠══════════════════════════════════════════════════════╣${C_RESET}"
    echo -e "${C_BURGUNDY}║${C_RESET} ${C_CREAM}Restore your Xray, SSH, & User Data safely.${C_RESET}          ${C_BURGUNDY}║${C_RESET}"
    echo -e "${C_BURGUNDY}╚══════════════════════════════════════════════════════╝${C_RESET}"
    echo -e ""
}

print_step() {
    echo -e "  ${C_GOLD}${ICON_GEAR} $1...${C_RESET}"
    sleep 0.5
}

print_success() {
    echo -e "  ${C_SAGE}${ICON_CHECK} $1${C_RESET}"
    sleep 0.3
}

print_error() {
    echo -e "  ${C_TOMATO}❌ $1${C_RESET}"
    sleep 1
}

# ==========================================================
#  MAIN LOGIC
# ==========================================================

# Check Root
if [ "$(id -u)" != "0" ]; then
    echo -e "${C_TOMATO}Error: This script requires root privileges.${C_RESET}"
    exit 1
fi

draw_header

# --- Warning ---
echo -e "${C_BURGUNDY}  .----------------------------------------------------.${C_RESET}"
echo -e "${C_BURGUNDY}  |${C_RESET} ${C_TOMATO}${ICON_WARN}  WARNING: THIS WILL OVERWRITE CURRENT DATA${C_RESET}       ${C_BURGUNDY}|${C_RESET}"
echo -e "${C_BURGUNDY}  '----------------------------------------------------'${C_RESET}"
echo ""

# --- Source Selection ---
echo -e "  ${C_GOLD}Select Restore Source:${C_RESET}"
echo -e "  ${C_BURGUNDY}[1]${C_RESET} ${C_CREAM}${ICON_DISK}  Local Backup (/root/)${C_RESET}"
echo -e "  ${C_BURGUNDY}[2]${C_RESET} ${C_CREAM}${ICON_CLOUD}  Link / URL (Google Drive)${C_RESET}"
echo ""
read -p "  Select Option (1/2): " source_option

BACKUP_FILE=""

case $source_option in
    1)
        echo -e "\n  ${C_GOLD}${ICON_DISK} Available Backup Files:${C_RESET}"
        ls -lh /root/*.zip 2>/dev/null | awk '{print "  - " $9 " (" $5 ")"}'
        echo ""
        read -p "  Enter filename (e.g., backup.zip): " input_file
        BACKUP_FILE="/root/$input_file"
        ;;
    2)
        echo -e "\n  ${C_GOLD}${ICON_CLOUD} Enter File Link:${C_RESET}"
        read -p "  Link URL: " link_url
        
        # Extract ID if it's a Drive Link, otherwise use raw link
        file_id=$(echo "$link_url" | grep -o '[a-zA-Z0-9_-]\{28,\}')
        BACKUP_FILE="/root/restore_temp.zip"
        
        print_step "Downloading Backup"
        if [ -n "$file_id" ]; then
            wget --quiet --show-progress "https://drive.google.com/uc?export=download&id=$file_id" -O "$BACKUP_FILE"
        else
            wget --quiet --show-progress "$link_url" -O "$BACKUP_FILE"
        fi
        ;;
    *)
        print_error "Invalid Option"
        exit 1
        ;;
esac

# --- Validation ---
if [ ! -f "$BACKUP_FILE" ]; then
    print_error "Backup file not found!"
    exit 1
fi

# --- Execution ---
TEMP_DIR="/root/restore_processing"
mkdir -p "$TEMP_DIR"

print_step "Extracting Backup Archive"
unzip -o "$BACKUP_FILE" -d "$TEMP_DIR" > /dev/null 2>&1

if [ $? -ne 0 ]; then
    print_error "Failed to unzip. Check password or file integrity."
    rm -rf "$TEMP_DIR"
    exit 1
fi

echo -e "${C_BURGUNDY}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${C_RESET}"

# --- Restore Process ---
# 1. Restore Xray
if [ -d "$TEMP_DIR/xray" ] || [ -d "$TEMP_DIR/etc/xray" ]; then
    print_step "Restoring Xray Config"
    rm -rf /etc/xray
    # Handle folder structure variations
    [ -d "$TEMP_DIR/xray" ] && cp -rf "$TEMP_DIR/xray" /etc/
    [ -d "$TEMP_DIR/etc/xray" ] && cp -rf "$TEMP_DIR/etc/xray" /etc/
    chmod -R 755 /etc/xray
    print_success "Xray Restored"
fi

# 2. Restore System Users (Shadow/Passwd)
if [ -f "$TEMP_DIR/passwd" ] || [ -f "$TEMP_DIR/etc/passwd" ]; then
    print_step "Restoring System Users"
    # Copy from flat root or etc folder inside zip
    [ -f "$TEMP_DIR/passwd" ] && cp "$TEMP_DIR/passwd" /etc/
    [ -f "$TEMP_DIR/group" ] && cp "$TEMP_DIR/group" /etc/
    [ -f "$TEMP_DIR/shadow" ] && cp "$TEMP_DIR/shadow" /etc/
    [ -f "$TEMP_DIR/gshadow" ] && cp "$TEMP_DIR/gshadow" /etc/
    
    [ -f "$TEMP_DIR/etc/passwd" ] && cp "$TEMP_DIR/etc/passwd" /etc/
    [ -f "$TEMP_DIR/etc/group" ] && cp "$TEMP_DIR/etc/group" /etc/
    [ -f "$TEMP_DIR/etc/shadow" ] && cp "$TEMP_DIR/etc/shadow" /etc/
    [ -f "$TEMP_DIR/etc/gshadow" ] && cp "$TEMP_DIR/etc/gshadow" /etc/
    print_success "Users Restored"
fi

# 3. Restore Web/HTML
if [ -d "$TEMP_DIR/html" ] || [ -d "$TEMP_DIR/var/www/html" ]; then
    print_step "Restoring Web Files"
    rm -rf /var/www/html
    [ -d "$TEMP_DIR/html" ] && cp -rf "$TEMP_DIR/html" /var/www/
    [ -d "$TEMP_DIR/var/www/html" ] && cp -rf "$TEMP_DIR/var/www/html" /var/www/
    print_success "Web Files Restored"
fi

# 4. Restore ZiVPN/Kyt Data
if [ -d "$TEMP_DIR/zivpn" ] || [ -d "$TEMP_DIR/etc/zivpn" ]; then
    print_step "Restoring ZiVPN/Kyt Database"
    rm -rf /etc/zivpn
    [ -d "$TEMP_DIR/zivpn" ] && cp -rf "$TEMP_DIR/zivpn" /etc/
    [ -d "$TEMP_DIR/etc/zivpn" ] && cp -rf "$TEMP_DIR/etc/zivpn" /etc/
    print_success "Database Restored"
fi

# --- Cleanup & Restart ---
print_step "Cleaning up temporary files"
rm -rf "$TEMP_DIR"
if [ "$source_option" -eq 2 ]; then
    rm -f "$BACKUP_FILE"
fi

print_step "Restarting Services"
systemctl daemon-reload
systemctl restart xray > /dev/null 2>&1
systemctl restart nginx > /dev/null 2>&1
systemctl restart ssh > /dev/null 2>&1
systemctl restart dropbear > /dev/null 2>&1
systemctl restart zivpn > /dev/null 2>&1

# --- Final Output ---
clear
echo -e "${C_BURGUNDY}╔══════════════════════════════════════════════════════╗${C_RESET}"
echo -e "${C_BURGUNDY}║${C_RESET} ${C_SAGE}   ${ICON_CHECK}       ${C_TOMATO}DATA RESTORE COMPLETED SUCCESSFULLY${C_RESET}     ${C_SAGE}${ICON_RESTORE}${C_RESET}      ${C_BURGUNDY}║${C_RESET}"
echo -e "${C_BURGUNDY}╚══════════════════════════════════════════════════════╝${C_RESET}"
echo -e ""
echo -e "  ${C_GOLD}Note:${C_RESET} ${C_CREAM}Please re-login or check services manually.${C_RESET}"
echo -e ""