#!/bin/bash

# ==========================================================
#  TOMATO LUXE THEME ENGINE - MAIN DASHBOARD
# ==========================================================

# 1. Palette Definition (True Color)
C_TOMATO="\033[38;2;217;69;57m"   # Primary Red
C_BURGUNDY="\033[38;2;143;38;38m" # Border Red
C_SAGE="\033[38;2;148;180;159m"   # Success Green
C_GOLD="\033[38;2;230;203;165m"   # Warning/Highlight
C_CREAM="\033[38;2;253;251;247m"  # Text
C_RESET="\033[0m"

# 2. Icons
ICON_TOMATO="ðŸ…"
ICON_VPS="ðŸ–¥ï¸"
ICON_CPU="ðŸ§ "
ICON_RAM="ðŸ’¾"
ICON_ISP="ðŸŒ"
ICON_LOC="ðŸ“"
ICON_CHECK="âœ”"
ICON_CROSS="âœ–"
ICON_STAR="âœ¨"
ICON_USER="ðŸ‘¤"
ICON_GEAR="âš™"
ICON_ARROW="âžœ"

# ==========================================================
#  SYSTEM GATHERING
# ==========================================================
clear
# Basic Info
IPVPS=$(curl -sS ipv4.icanhazip.com)
ISP=$(cat /root/.info/.isp 2>/dev/null || echo "Unknown ISP")
CITY=$(cat /root/.info/.city 2>/dev/null || echo "Unknown City")
DOMAIN=$(cat /etc/xray/domain 2>/dev/null || echo "No Domain")

# Hardware Info
RAM_USED=$(free -m | awk 'NR==2 {print $3}')
RAM_TOTAL=$(free -m | awk 'NR==2 {print $2}')
RAM_PERC=$(free | grep Mem | awk '{print $3/$2 * 100.0}')
CPU_LOAD=$(top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1"%"}')
OS_NAME=$(cat /etc/os-release | grep -w PRETTY_NAME | head -n1 | sed 's/=//g' | sed 's/"//g' | sed 's/PRETTY_NAME//g')
KERNEL=$(uname -r)
UPTIME=$(uptime -p | cut -d " " -f 2-10)

# License Check (Simulated based on original script)
IZIN_URL="https://raw.githubusercontent.com/dudul19/license/main/tomato"
USER_DATA=$(curl -s ${IZIN_URL} | grep $IPVPS)
VALID_UNTIL=$(echo "$USER_DATA" | awk '{print $3}')

if [[ -z "$VALID_UNTIL" ]]; then
    LICENSE_STATUS="${C_TOMATO}Trial / Unregistered${C_RESET}"
    DAYS_LEFT="0"
else
    TODAY=$(date +"%Y-%m-%d")
    D1=$(date -d "$VALID_UNTIL" +%s)
    D2=$(date -d "$TODAY" +%s)
    DAYS_LEFT=$(((D1 - D2) / 86400))
    
    if [[ "$D1" -ge "$D2" ]]; then
        LICENSE_STATUS="${C_SAGE}Premium License${C_RESET}"
    else
        LICENSE_STATUS="${C_TOMATO}Expired License${C_RESET}"
        DAYS_LEFT="0"
    fi
fi

# ==========================================================
#  HELPER FUNCTIONS
# ==========================================================

# Service Status Checker
check_service() {
    if systemctl is-active --quiet "$1"; then
        echo -e "${C_SAGE}ON ${ICON_CHECK}${C_RESET}"
    else
        echo -e "${C_TOMATO}OFF ${ICON_CROSS}${C_RESET}"
    fi
}

# SSH WS Status specific check
check_ws_epro() {
    if systemctl is-active --quiet ws; then
         echo -e "${C_SAGE}ON ${ICON_CHECK}${C_RESET}"
    else
         echo -e "${C_TOMATO}OFF ${ICON_CROSS}${C_RESET}"
    fi
}

# Speedtest Function
run_speedtest() {
    clear
    echo -e "${C_BURGUNDY}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${C_RESET}"
    echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_SAGE}${ICON_TOMATO}    ${C_TOMATO}TOMATO TOOLS${C_RESET} ${C_GOLD}(NETWORK SPEEDTEST)${C_RESET}             ${C_BURGUNDY}â•‘${C_RESET}"
    echo -e "${C_BURGUNDY}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${C_RESET}"
    echo -e ""
    echo -e "  ${C_GOLD}${ICON_GEAR} Measuring network speed...${C_RESET}"
    
    # Install if missing
    if ! command -v speedtest-cli &> /dev/null; then
        echo -e "  ${C_TOMATO}Installing Speedtest CLI...${C_RESET}"
        apt-get install speedtest-cli -y > /dev/null 2>&1
    fi

    rm -f /tmp/speedtest.txt
    speedtest-cli --simple --secure > /tmp/speedtest.txt 2> /dev/null

    if [[ -s /tmp/speedtest.txt ]]; then
        PING=$(grep "Ping" /tmp/speedtest.txt | awk '{print $2}')
        DL=$(grep "Download" /tmp/speedtest.txt | awk '{print $2}')
        UL=$(grep "Upload" /tmp/speedtest.txt | awk '{print $2}')
        
        echo -e "${C_BURGUNDY}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${C_RESET}"
        printf "${C_BURGUNDY}â•‘${C_RESET} ${C_CREAM}%-15s${C_RESET} : ${C_SAGE}%-32s${C_RESET}   ${C_BURGUNDY}â•‘${C_RESET}\n" "Latency" "$PING ms"
        printf "${C_BURGUNDY}â•‘${C_RESET} ${C_CREAM}%-15s${C_RESET} : ${C_GOLD}%-32s${C_RESET}   ${C_BURGUNDY}â•‘${C_RESET}\n" "Download" "$DL Mbps"
        printf "${C_BURGUNDY}â•‘${C_RESET} ${C_CREAM}%-15s${C_RESET} : ${C_GOLD}%-32s${C_RESET}   ${C_BURGUNDY}â•‘${C_RESET}\n" "Upload" "$UL Mbps"
        echo -e "${C_BURGUNDY}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${C_RESET}"
    else
        echo -e "  ${C_TOMATO}${ICON_CROSS} Speedtest Failed. Check internet connection.${C_RESET}"
    fi
    echo -e ""
    read -n 1 -s -r -p "Press any key to return..."
}

# ==========================================================
#  DATA FETCHING (COUNTERS)
# ==========================================================

# Account Counters (Logic original maintained)
total_ssh=$(awk -F: '$3 >= 1000 && $1 != "nobody" {print $1}' /etc/passwd | wc -l)
total_vless=$(grep -c -E "^#& " "/etc/xray/config.json" 2>/dev/null || echo 0); let total_vless=$total_vless/2
total_vmess=$(grep -c -E "^### " "/etc/xray/config.json" 2>/dev/null || echo 0); let total_vmess=$total_vmess/2
total_trojan=$(grep -c -E "^#! " "/etc/xray/config.json" 2>/dev/null || echo 0); let total_trojan=$total_trojan/2
total_ss=$(grep -c -E "^#ss# " "/etc/xray/config.json" 2>/dev/null || echo 0); let total_ss=$total_ss/2

# Service Status
s_ssh=$(check_service ssh)
s_xray=$(check_service xray)
s_nginx=$(check_service nginx)
s_haproxy=$(check_service haproxy)
s_dropbear=$(check_service dropbear)
s_ws_epro=$(check_ws_epro)
s_udp=$(check_service udp-custom)
s_zivpn=$(check_service zivpn)

# ==========================================================
#  MAIN DASHBOARD RENDER
# ==========================================================
clear
echo -e "${C_BURGUNDY}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${C_RESET}"
echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_SAGE}          ${ICON_TOMATO}  ${C_TOMATO}TOMATO AUTOSCRIPT${C_RESET} ${C_GOLD}(PREMIUM)${C_RESET}            ${C_BURGUNDY}â•‘${C_RESET}"
echo -e "${C_BURGUNDY}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${C_RESET}"
# System Info
echo -e "${C_BURGUNDY} ${C_RESET} ${C_GOLD}${ICON_VPS}  OS       :${C_RESET} ${C_CREAM}${OS_NAME:0:20}${C_RESET}"
echo -e "${C_BURGUNDY} ${C_RESET} ${C_GOLD}${ICON_ISP} IP/ISP   :${C_RESET} ${C_CREAM}${IPVPS} (${ISP:0:10})${C_RESET}"
echo -e "${C_BURGUNDY} ${C_RESET} ${C_GOLD}${ICON_STAR} Domain   :${C_RESET} ${C_CREAM}${DOMAIN}${C_RESET}"
echo -e "${C_BURGUNDY} ${C_RESET} ${C_GOLD}${ICON_RAM} RAM      :${C_RESET} ${C_CREAM}${RAM_USED}/${RAM_TOTAL}MB${C_RESET} ${C_GOLD}${C_RESET}"
echo -e "${C_BURGUNDY} ${C_RESET} ${C_GOLD}${ICON_CPU} CPU      :${C_RESET} ${C_CREAM}${CPU_LOAD}"
echo -e "${C_BURGUNDY} ${C_RESET} ${C_GOLD}${ICON_USER} Version  :${C_RESET} ${C_CREAM}Tomat Merah V.1.1 - LTS${C_RESET}"
echo -e "${C_BURGUNDY} ${C_RESET} ${C_GOLD}${ICON_CHECK}  License  :${C_RESET} ${LICENSE_STATUS} ${C_CREAM}(${DAYS_LEFT} Days)${C_RESET}"
echo -e "${C_BURGUNDY}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${C_RESET}"

# Service Status (2 Column)
echo -e "${C_BURGUNDY}â•‘${C_RESET}                    ${C_SAGE}SERVICE STATUS${C_RESET}                    ${C_BURGUNDY}â•‘${C_RESET}"
echo -e "${C_BURGUNDY}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${C_RESET}"
printf "${C_BURGUNDY}â•‘${C_RESET} ${C_CREAM}%-10s${C_RESET} %-13s          ${C_BURGUNDY}â”‚${C_RESET} ${C_CREAM}%-10s${C_RESET} %-14s         ${C_BURGUNDY}â•‘${C_RESET}\n" "SSH" "$s_ssh" "XRAY" "$s_xray"
printf "${C_BURGUNDY}â•‘${C_RESET} ${C_CREAM}%-10s${C_RESET} %-13s          ${C_BURGUNDY}â”‚${C_RESET} ${C_CREAM}%-10s${C_RESET} %-14s         ${C_BURGUNDY}â•‘${C_RESET}\n" "NGINX" "$s_nginx" "HAPROXY" "$s_haproxy"
printf "${C_BURGUNDY}â•‘${C_RESET} ${C_CREAM}%-10s${C_RESET} %-13s          ${C_BURGUNDY}â”‚${C_RESET} ${C_CREAM}%-10s${C_RESET} %-14s         ${C_BURGUNDY}â•‘${C_RESET}\n" "WS-EPRO" "$s_ws_epro" "DROPBEAR" "$s_dropbear"
printf "${C_BURGUNDY}â•‘${C_RESET} ${C_CREAM}%-10s${C_RESET} %-13s          ${C_BURGUNDY}â”‚${C_RESET} ${C_CREAM}%-10s${C_RESET} %-14s         ${C_BURGUNDY}â•‘${C_RESET}\n" "UDP-CUST" "$s_udp" "ZIVPN" "$s_zivpn"
echo -e "${C_BURGUNDY}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${C_RESET}"

# Account Stats
echo -e "${C_BURGUNDY}â•‘${C_RESET}                    ${C_GOLD}ACCOUNT STATS${C_RESET}                     ${C_BURGUNDY}â•‘${C_RESET}"
echo -e "${C_BURGUNDY}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${C_RESET}"
printf "${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}%-10s${C_RESET} ${C_CREAM}: %-11s${C_RESET} ${C_BURGUNDY}â”‚${C_RESET} ${C_GOLD}%-10s${C_RESET} ${C_CREAM}: %-12s${C_RESET} ${C_BURGUNDY}â•‘${C_RESET}\n" "SSH/OVPN" "$total_ssh" "VLESS" "$total_vless"
printf "${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}%-10s${C_RESET} ${C_CREAM}: %-11s${C_RESET} ${C_BURGUNDY}â”‚${C_RESET} ${C_GOLD}%-10s${C_RESET} ${C_CREAM}: %-12s${C_RESET} ${C_BURGUNDY}â•‘${C_RESET}\n" "VMESS" "$total_vmess" "TROJAN" "$total_trojan"
printf "${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}%-10s${C_RESET} ${C_CREAM}: %-11s${C_RESET} ${C_BURGUNDY}â”‚${C_RESET} ${C_GOLD}%-10s${C_RESET} ${C_CREAM}: %-12s${C_RESET} ${C_BURGUNDY}â•‘${C_RESET}\n" "SHADOW" "$total_ss" "ZIVPN" "$total_ssh"
echo -e "${C_BURGUNDY}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${C_RESET}"

# Menu Options
echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}[01]${C_RESET} ${C_CREAM}MENU SSH${C_RESET}            ${C_BURGUNDY}â”‚${C_RESET} ${C_GOLD}[06]${C_RESET} ${C_CREAM}MENU TRIAL${C_RESET}           ${C_BURGUNDY}â•‘${C_RESET}"
echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}[02]${C_RESET} ${C_CREAM}MENU VMESS${C_RESET}          ${C_BURGUNDY}â”‚${C_RESET} ${C_GOLD}[07]${C_RESET} ${C_CREAM}MENU SLOWDNS${C_RESET}         ${C_BURGUNDY}â•‘${C_RESET}"
echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}[03]${C_RESET} ${C_CREAM}MENU VLESS${C_RESET}          ${C_BURGUNDY}â”‚${C_RESET} ${C_GOLD}[08]${C_RESET} ${C_CREAM}MENU UTILITY${C_RESET}         ${C_BURGUNDY}â•‘${C_RESET}"
echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}[04]${C_RESET} ${C_CREAM}MENU TROJAN${C_RESET}         ${C_BURGUNDY}â”‚${C_RESET} ${C_GOLD}[09]${C_RESET} ${C_CREAM}MENU ZIVPN${C_RESET}           ${C_BURGUNDY}â•‘${C_RESET}"
echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_GOLD}[05]${C_RESET} ${C_CREAM}MENU SSWS${C_RESET}           ${C_BURGUNDY}â”‚${C_RESET} ${C_GOLD}[10]${C_RESET} ${C_CREAM}SPEEDTEST${C_RESET}            ${C_BURGUNDY}â•‘${C_RESET}"
echo -e "${C_BURGUNDY}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${C_RESET}"
echo -e "${C_BURGUNDY}â•‘${C_RESET} ${C_TOMATO}[00]${C_RESET} ${C_TOMATO}EXIT PANEL${C_RESET}          ${C_BURGUNDY}â”‚${C_RESET} ${C_GOLD}[99]${C_RESET} ${C_GOLD}REBOOT VPS${C_RESET}           ${C_BURGUNDY}â•‘${C_RESET}"
echo -e "${C_BURGUNDY}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${C_RESET}"
echo -e ""
echo -e " ${C_GOLD}${ICON_ARROW} Select Option:${C_RESET}"
read -p " > " opt

case $opt in
    1|01) clear ; m-sshws ;;
    2|02) clear ; m-vmess ;;
    3|03) clear ; m-vless ;;
    4|04) clear ; m-trojan ;;
    5|05) clear ; m-ssws ;;
    6|06) clear ; m-trial ;;
    7|07) clear ; sd ;;
    8|08) clear ; menu-x ;;
    9|09) clear ; zivpn-menu ;;
    10) clear ; run_speedtest ; menu ;;
    99) clear ; echo -e "${C_GOLD}Rebooting VPS...${C_RESET}"; reboot ;;
    0|00) clear ; echo -e "${C_SAGE}Thank you for using Tomato Autoscript.${C_RESET}"; exit ;;
    x) menu ;;
    *) echo -e "${C_TOMATO}Invalid Option.${C_RESET}"; sleep 1; menu ;;
esac