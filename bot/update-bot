#!/bin/bash

# ==========================================================
#  TOMATO LUXE THEME ENGINE - BOT UPDATE
# ==========================================================

# 1. Palette Definition (True Color)
C_TOMATO="\033[38;2;217;69;57m"   # Primary Red
C_BURGUNDY="\033[38;2;143;38;38m" # Border Red
C_SAGE="\033[38;2;148;180;159m"   # Success Green
C_GOLD="\033[38;2;230;203;165m"   # Warning/Highlight
C_CREAM="\033[38;2;253;251;247m"  # Text
C_RESET="\033[0m"

# 2. Icons
ICON_BOT="🤖"
ICON_DL="📥"
ICON_INSTALL="📦"
ICON_FIX="🛠️"
ICON_CHECK="✔"
ICON_STOP="🛑"
ICON_START="🚀"
ICON_STAR="✨"

# 3. Source Config
REPO_ROOT="https://raw.githubusercontent.com/dudul19/tomato/main/bot"
DIR_MODULES="/usr/bin/kyt/modules"
DIR_SHELL="/usr/bin/kyt/shell"

# ==========================================================
#  UI FUNCTIONS
# ==========================================================

draw_header() {
    clear
    echo -e "${C_BURGUNDY}╔══════════════════════════════════════════════════════╗${C_RESET}"
    echo -e "${C_BURGUNDY}║${C_RESET} ${C_SAGE}        ${ICON_BOT}  ${C_TOMATO}TOMATO MANAGER${C_RESET} ${C_GOLD}(BOT TELEGRAM)${C_RESET}            ${C_BURGUNDY}║${C_RESET}"
    echo -e "${C_BURGUNDY}╠══════════════════════════════════════════════════════╣${C_RESET}"
    echo -e "${C_BURGUNDY}║${C_RESET} ${C_GOLD}${ICON_STAR} AUTHOR   : ${C_CREAM}@dudulrealnofek ${C_RESET}                       ${C_BURGUNDY}║${C_RESET}"
    echo -e "${C_BURGUNDY}║${C_RESET} ${C_SAGE}${ICON_ROCKET} VERSION  : ${C_CREAM}Tomat Merah V.1.1 - LTS${C_RESET}                ${C_BURGUNDY}║${C_RESET}"
    echo -e "${C_BURGUNDY}╚══════════════════════════════════════════════════════╝${C_RESET}"
    echo -e ""
}

print_step() {
    echo -e "  ${C_GOLD}$1 ${C_CREAM}$2...${C_RESET}"
    sleep 0.5
}

print_success() {
    echo -e "  ${C_SAGE}${ICON_CHECK} $1${C_RESET}"
    sleep 0.3
}

# ==========================================================
#  MAIN LOGIC
# ==========================================================

draw_header

# 1. STOP SERVICE
echo -e "${C_BURGUNDY}  .----------------------------------------------------.${C_RESET}"
echo -e "${C_BURGUNDY}  |${C_RESET}                 ${C_GOLD}STARTING UPDATE${C_RESET}                    ${C_BURGUNDY}|${C_RESET}"
echo -e "${C_BURGUNDY}  '----------------------------------------------------'${C_RESET}"

print_step "${ICON_STOP}" "Stopping Bot Service"
systemctl stop kyt > /dev/null 2>&1

# 2. UPDATE MODULES
print_step "${ICON_DL}" "Updating Modules"
rm -rf "$DIR_MODULES"
mkdir -p "$DIR_MODULES"
cd /tmp
wget -q -O modules.zip "${REPO_ROOT}/modules.zip"

if [[ -f modules.zip ]]; then
    unzip -o modules.zip > /dev/null 2>&1
    # Smart Move: Cek apakah hasil unzip ada folder 'modules' atau flat file
    if [ -d "modules" ]; then
        mv modules/* "$DIR_MODULES/"
    else
        # Jika flat file (langsung isi) atau struktur berbeda, copy yang relevan
        # Asumsi: jika tidak ada folder modules, file ada di root unzip
        mv *.py "$DIR_MODULES/" 2>/dev/null
        mv *.sh "$DIR_MODULES/" 2>/dev/null
    fi
    rm -rf modules modules.zip
    print_success "Modules Updated"
else
    echo -e "  ${C_TOMATO}Error: Download modules failed.${C_RESET}"
fi

# 3. UPDATE SHELL (SCRIPTS)
print_step "${ICON_DL}" "Updating Shell Scripts"
rm -rf "$DIR_SHELL"
mkdir -p "$DIR_SHELL"
cd /tmp
wget -q -O shell.zip "${REPO_ROOT}/shell.zip"

if [[ -f shell.zip ]]; then
    unzip -o shell.zip > /dev/null 2>&1
    if [ -d "shell" ]; then
        mv shell/* "$DIR_SHELL/"
    else
        mv *.sh "$DIR_SHELL/" 2>/dev/null
    fi
    rm -rf shell shell.zip
    print_success "Shell Scripts Updated"
else
    echo -e "  ${C_TOMATO}Error: Download shell failed.${C_RESET}"
fi

# 4. PERMISSIONS & FIX (DOS2UNIX)
print_step "${ICON_FIX}" "Normalizing File Permissions"

chmod +x -R "$DIR_SHELL"
chmod +x -R "$DIR_MODULES"

# Universal Fixer: Memperbaiki semua file di folder kyt dari error ^M (Windows format)
find /usr/bin/kyt/ -type f -exec sed -i 's/\r$//' {} \;

print_success "System Normalized"

# 5. RESTART SERVICE
print_step "${ICON_START}" "Restarting Bot Service"
systemctl enable kyt > /dev/null 2>&1
systemctl restart kyt > /dev/null 2>&1

# ==========================================================
#  COMPLETION
# ==========================================================

echo -e ""
echo -e "${C_BURGUNDY}╔══════════════════════════════════════════════════════╗${C_RESET}"
echo -e "${C_BURGUNDY}║${C_RESET} ${C_SAGE}   ${ICON_CHECK}       ${C_TOMATO}BOT UPDATE COMPLETED SUCCESSFULLY${C_RESET}    ${C_SAGE}${ICON_BOT}${C_RESET}   ${C_BURGUNDY}║${C_RESET}"
echo -e "${C_BURGUNDY}╚══════════════════════════════════════════════════════╝${C_RESET}"
echo -e ""
echo -e "  ${C_SAGE}Check your bot status using /start${C_RESET}"
echo -e ""
rm -f update-bot
read -n 1 -s -r -p "Press any key to return to menu..."
menu